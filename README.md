# Hospital Patient Management System

This repository contains a small Java EE / Jakarta EE web application (WAR) for managing patient records and synchronizing with an external Electronic Patient Record (EPA).

The README below summarizes the project structure, how to build and deploy, database setup, and troubleshooting notes.

## Repository layout (important files and directories)

```
hospital-system/
├─ pom.xml                    # Maven project file
├─ README.md                  # This file (English)
├─ README-setup-wildfly-postgres.md
├─ scripts/
│  └─ setup-wildfly-postgres.sh  # helper script for DB + WildFly setup
├─ src/
│  ├─ main/
│  │  ├─ java/
│  │  │  └─ com/hospital/
│  │  │     ├─ entity/         # JPA entities (Patient, Diagnosis, Medication)
│  │  │     ├─ epa/            # EPA integration service & helpers
│  │  │     └─ rest/           # JAX-RS resources (PatientResource, EPAResource)
│  │  ├─ resources/
│  │  │  └─ META-INF/persistence.xml  # JPA persistence unit (JNDI name hospitalPU)
│  │  └─ webapp/
│  │     └─ index.html         # simple single-file UI for demonstration
└─ target/                    # build artifacts (generated by Maven)
```

## What this project contains

- Java backend: JAX-RS endpoints in `com.hospital.rest` exposing patient CRUD and EPA actions.
- JPA entities: `com.hospital.entity` contains domain types (Patient, Diagnosis, Medication).
- EPA integration: `com.hospital.epa` contains `EPAIntegrationService` and small DTOs used to call an external EPA system (FHIR over HTTP).
- Minimal frontend: a single `index.html` providing a lightweight UI that talks to the REST API.
- Helper script: `scripts/setup-wildfly-postgres.sh` automates common tasks for local setup (DB user, DB creation, JDBC driver module, datasource creation). See `README-setup-wildfly-postgres.md` for details.

## Build and package

This is a Maven WAR project. To build:

```bash
mvn clean package
```

The produced artifact is `target/hospital-management.war`.

## Deployment (WildFly)

The app is intended for WildFly / JBoss AS. The persistence unit used in code is named `hospitalPU` and expects a JTA datasource bound to `java:jboss/datasources/HospitalDS`.

To deploy manually:

```bash
cp target/hospital-management.war /opt/wildfly/standalone/deployments/
# or with CLI
/opt/wildfly/bin/jboss-cli.sh --connect --command='deploy /path/to/target/hospital-management.war'
```

## Database

- The project uses PostgreSQL. The helper script expects a database named `hospitaldb` and a DB user `hospitaluser` by default.
- To apply the included SQL schemas (if you have not already), run the helper script from the repo root:

```bash
sudo DB_PASS='dbpassword' SET_DB_PASS=true IMPORT_SQL=true ./scripts/setup-wildfly-postgres.sh
```

## Front-end

- `src/main/webapp/index.html` is a self-contained frontend. It communicates with the backend at two base paths used in the code:
  - `/hospital-management/api/patients`
  - `/hospital-management/api/epa`

## Troubleshooting / Known issues

- EPA test returns 503 (Service Unavailable): the backend endpoint `api/epa/test-connection` indicated the external EPA could not be reached (or timed out). Check `EPA_BASE_URL` and `EPA_API_KEY` environment variables and WildFly logs for details.

- 500 when calling `api/patients` with JSON-B serialization error for `diagnoses`: JSON-B failed to serialize entity relationships (common with bidirectional JPA relations and lazy proxies). To mitigate this:
  - Short-term: some relationships were marked with `@JsonbTransient` to avoid serialization cycles.
  - Recommended long-term: map entities to DTOs in the REST layer (PatientDTO) so the API responses are explicit and stable.

## Development notes

- To run a full rebuild use `mvn clean package`.
- If you change entity mappings, re-generate the WAR and redeploy. Watch the server logs for deployment errors.
