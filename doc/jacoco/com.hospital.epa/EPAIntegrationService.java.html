<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EPAIntegrationService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Hospital Patient Management System</a> &gt; <a href="index.source.html" class="el_package">com.hospital.epa</a> &gt; <span class="el_source">EPAIntegrationService.java</span></div><h1>EPAIntegrationService.java</h1><pre class="source lang-java linenums">package com.hospital.epa;

import java.util.logging.Logger;

import com.hospital.entity.Patient;

import jakarta.ejb.Stateless;
import jakarta.inject.Inject;
import jakarta.ws.rs.client.Client;
import jakarta.ws.rs.client.ClientBuilder;
import jakarta.ws.rs.client.Entity;
import jakarta.ws.rs.core.MediaType;
import jakarta.ws.rs.core.Response;

/**
 * Service für die Kommunikation mit der elektronischen Patientenakte (EPA)
 * Unterstützt FHIR-Standard für Interoperabilität
 */
@Stateless
<span class="fc" id="L20">public class EPAIntegrationService {</span>

<span class="fc" id="L22">    private static final Logger LOGGER = Logger.getLogger(EPAIntegrationService.class.getName());</span>

    // EPA-System Basis-URL (konfigurierbar über Umgebungsvariablen)
<span class="fc" id="L25">    private static final String EPA_BASE_URL = System.getenv()</span>
<span class="fc" id="L26">            .getOrDefault(&quot;EPA_BASE_URL&quot;, &quot;https://epa-system.example.com/api&quot;);</span>

<span class="fc" id="L28">    private static final String EPA_API_KEY = System.getenv()</span>
<span class="fc" id="L29">            .getOrDefault(&quot;EPA_API_KEY&quot;, &quot;your-api-key&quot;);</span>

    @Inject
    private FHIRConverter fhirConverter;

    /**
     * Sendet Patientendaten an die EPA
     */
    public EPAResponse sendPatientToEPA(Patient patient) {
<span class="fc" id="L38">        LOGGER.info(&quot;Sende Patient &quot; + patient.getId() + &quot; an EPA&quot;);</span>

        try {
            // Konvertiere Patient zu FHIR-Format
<span class="fc" id="L42">            String fhirPatient = fhirConverter.patientToFHIR(patient);</span>

<span class="fc" id="L44">            Client client = ClientBuilder.newClient();</span>
<span class="fc" id="L45">            Response response = client.target(EPA_BASE_URL + &quot;/Patient&quot;)</span>
<span class="fc" id="L46">                    .request(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L47">                    .header(&quot;Authorization&quot;, &quot;Bearer &quot; + EPA_API_KEY)</span>
<span class="fc" id="L48">                    .header(&quot;Content-Type&quot;, &quot;application/fhir+json&quot;)</span>
<span class="nc" id="L49">                    .post(Entity.json(fhirPatient));</span>

<span class="nc bnc" id="L51" title="All 4 branches missed.">            if (response.getStatus() == 201 || response.getStatus() == 200) {</span>
<span class="nc" id="L52">                String epaId = response.readEntity(String.class);</span>
<span class="nc" id="L53">                LOGGER.info(&quot;Patient erfolgreich an EPA gesendet. EPA-ID: &quot; + epaId);</span>
<span class="nc" id="L54">                return new EPAResponse(true, epaId, &quot;Patient erfolgreich übertragen&quot;);</span>
            } else {
<span class="nc" id="L56">                String error = response.readEntity(String.class);</span>
<span class="nc" id="L57">                LOGGER.warning(&quot;EPA-Fehler: &quot; + error);</span>
<span class="nc" id="L58">                return new EPAResponse(false, null, &quot;Fehler bei EPA-Übertragung: &quot; + error);</span>
            }

<span class="fc" id="L61">        } catch (Exception e) {</span>
<span class="fc" id="L62">            LOGGER.severe(&quot;Fehler bei EPA-Übertragung: &quot; + e.getMessage());</span>
<span class="fc" id="L63">            return new EPAResponse(false, null, &quot;Technischer Fehler: &quot; + e.getMessage());</span>
        }
    }

    /**
     * Aktualisiert Patientendaten in der EPA
     */
    public EPAResponse updatePatientInEPA(Patient patient, String epaId) {
<span class="nc" id="L71">        LOGGER.info(&quot;Aktualisiere Patient &quot; + patient.getId() + &quot; in EPA (EPA-ID: &quot; + epaId + &quot;)&quot;);</span>

        try {
<span class="nc" id="L74">            String fhirPatient = fhirConverter.patientToFHIR(patient);</span>

<span class="nc" id="L76">            Client client = ClientBuilder.newClient();</span>
<span class="nc" id="L77">            Response response = client.target(EPA_BASE_URL + &quot;/Patient/&quot; + epaId)</span>
<span class="nc" id="L78">                    .request(MediaType.APPLICATION_JSON)</span>
<span class="nc" id="L79">                    .header(&quot;Authorization&quot;, &quot;Bearer &quot; + EPA_API_KEY)</span>
<span class="nc" id="L80">                    .header(&quot;Content-Type&quot;, &quot;application/fhir+json&quot;)</span>
<span class="nc" id="L81">                    .put(Entity.json(fhirPatient));</span>

<span class="nc bnc" id="L83" title="All 2 branches missed.">            if (response.getStatus() == 200) {</span>
<span class="nc" id="L84">                LOGGER.info(&quot;Patient erfolgreich in EPA aktualisiert&quot;);</span>
<span class="nc" id="L85">                return new EPAResponse(true, epaId, &quot;Patient erfolgreich aktualisiert&quot;);</span>
            } else {
<span class="nc" id="L87">                String error = response.readEntity(String.class);</span>
<span class="nc" id="L88">                return new EPAResponse(false, null, &quot;Fehler bei EPA-Update: &quot; + error);</span>
            }

<span class="nc" id="L91">        } catch (Exception e) {</span>
<span class="nc" id="L92">            LOGGER.severe(&quot;Fehler bei EPA-Update: &quot; + e.getMessage());</span>
<span class="nc" id="L93">            return new EPAResponse(false, null, &quot;Technischer Fehler: &quot; + e.getMessage());</span>
        }
    }

    /**
     * Ruft Patientendaten aus der EPA ab
     */
    public String getPatientFromEPA(String epaId) {
<span class="nc" id="L101">        LOGGER.info(&quot;Rufe Patient mit EPA-ID &quot; + epaId + &quot; ab&quot;);</span>

        try {
<span class="nc" id="L104">            Client client = ClientBuilder.newClient();</span>
<span class="nc" id="L105">            Response response = client.target(EPA_BASE_URL + &quot;/Patient/&quot; + epaId)</span>
<span class="nc" id="L106">                    .request(MediaType.APPLICATION_JSON)</span>
<span class="nc" id="L107">                    .header(&quot;Authorization&quot;, &quot;Bearer &quot; + EPA_API_KEY)</span>
<span class="nc" id="L108">                    .get();</span>

<span class="nc bnc" id="L110" title="All 2 branches missed.">            if (response.getStatus() == 200) {</span>
<span class="nc" id="L111">                return response.readEntity(String.class);</span>
            } else {
<span class="nc" id="L113">                LOGGER.warning(&quot;Patient nicht in EPA gefunden&quot;);</span>
<span class="nc" id="L114">                return null;</span>
            }

<span class="nc" id="L117">        } catch (Exception e) {</span>
<span class="nc" id="L118">            LOGGER.severe(&quot;Fehler beim EPA-Abruf: &quot; + e.getMessage());</span>
<span class="nc" id="L119">            return null;</span>
        }
    }

    /**
     * Synchronisiert alle aktiven Patienten mit der EPA
     */
    public EPASyncResult syncAllPatientsToEPA(java.util.List&lt;Patient&gt; patients) {
<span class="fc" id="L127">        int success = 0;</span>
<span class="fc" id="L128">        int failed = 0;</span>

<span class="fc bfc" id="L130" title="All 2 branches covered.">        for (Patient patient : patients) {</span>
<span class="fc" id="L131">            EPAResponse response = sendPatientToEPA(patient);</span>
<span class="pc bpc" id="L132" title="1 of 2 branches missed.">            if (response.isSuccess()) {</span>
<span class="nc" id="L133">                success++;</span>
            } else {
<span class="fc" id="L135">                failed++;</span>
            }
<span class="fc" id="L137">        }</span>

<span class="fc" id="L139">        return new EPASyncResult(success, failed);</span>
    }

    /**
     * Prüft die Verbindung zur EPA
     */
    public boolean testEPAConnection() {
        try {
<span class="fc" id="L147">            Client client = ClientBuilder.newClient();</span>
<span class="fc" id="L148">            Response response = client.target(EPA_BASE_URL + &quot;/health&quot;)</span>
<span class="fc" id="L149">                    .request()</span>
<span class="fc" id="L150">                    .header(&quot;Authorization&quot;, &quot;Bearer &quot; + EPA_API_KEY)</span>
<span class="nc" id="L151">                    .get();</span>

<span class="nc bnc" id="L153" title="All 2 branches missed.">            return response.getStatus() == 200;</span>
<span class="fc" id="L154">        } catch (Exception e) {</span>
<span class="fc" id="L155">            LOGGER.severe(&quot;EPA-Verbindungstest fehlgeschlagen: &quot; + e.getMessage());</span>
<span class="fc" id="L156">            return false;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>