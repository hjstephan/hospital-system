<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PatientResource.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Hospital Patient Management System</a> &gt; <a href="index.source.html" class="el_package">com.hospital.rest</a> &gt; <span class="el_source">PatientResource.java</span></div><h1>PatientResource.java</h1><pre class="source lang-java linenums">package com.hospital.rest;

import java.util.List;

import com.hospital.entity.Patient;

import jakarta.ejb.Stateless;
import jakarta.persistence.EntityManager;
import jakarta.persistence.PersistenceContext;
import jakarta.ws.rs.Consumes;
import jakarta.ws.rs.DELETE;
import jakarta.ws.rs.GET;
import jakarta.ws.rs.POST;
import jakarta.ws.rs.PUT;
import jakarta.ws.rs.Path;
import jakarta.ws.rs.PathParam;
import jakarta.ws.rs.Produces;
import jakarta.ws.rs.QueryParam;
import jakarta.ws.rs.core.GenericEntity;
import jakarta.ws.rs.core.MediaType;
import jakarta.ws.rs.core.Response;

@Stateless
@Path(&quot;/patients&quot;)
@Produces(MediaType.APPLICATION_JSON)
@Consumes(MediaType.APPLICATION_JSON)
<span class="fc" id="L27">public class PatientResource {</span>

    @PersistenceContext(unitName = &quot;hospitalPU&quot;)
    private EntityManager em;

    @GET
    public Response getAllPatients(@QueryParam(&quot;status&quot;) String status) {
        try {
            List&lt;Patient&gt; patients;
<span class="fc bfc" id="L36" title="All 2 branches covered.">            if (&quot;active&quot;.equals(status)) {</span>
<span class="fc" id="L37">                patients = em.createNamedQuery(&quot;Patient.findActive&quot;, Patient.class)</span>
<span class="fc" id="L38">                        .getResultList();</span>
            } else {
<span class="fc" id="L40">                patients = em.createNamedQuery(&quot;Patient.findAll&quot;, Patient.class)</span>
<span class="fc" id="L41">                        .getResultList();</span>
            }
<span class="fc" id="L43">            GenericEntity&lt;List&lt;Patient&gt;&gt; entity = new GenericEntity&lt;List&lt;Patient&gt;&gt;(patients) {</span>
            };
<span class="fc" id="L45">            return Response.ok(entity).build();</span>
<span class="fc" id="L46">        } catch (Exception e) {</span>
<span class="fc" id="L47">            return Response.status(Response.Status.INTERNAL_SERVER_ERROR)</span>
<span class="fc" id="L48">                    .entity(&quot;{\&quot;error\&quot;: \&quot;&quot; + e.getMessage() + &quot;\&quot;}&quot;).build();</span>
        }
    }

    @GET
    @Path(&quot;/{id}&quot;)
    public Response getPatient(@PathParam(&quot;id&quot;) Long id) {
        try {
<span class="fc" id="L56">            Patient patient = em.find(Patient.class, id);</span>
<span class="fc bfc" id="L57" title="All 2 branches covered.">            if (patient == null) {</span>
<span class="fc" id="L58">                return Response.status(Response.Status.NOT_FOUND)</span>
<span class="fc" id="L59">                        .entity(&quot;{\&quot;error\&quot;: \&quot;Patient nicht gefunden\&quot;}&quot;).build();</span>
            }
<span class="fc" id="L61">            return Response.ok(patient).build();</span>
<span class="nc" id="L62">        } catch (Exception e) {</span>
<span class="nc" id="L63">            return Response.status(Response.Status.INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L64">                    .entity(&quot;{\&quot;error\&quot;: \&quot;&quot; + e.getMessage() + &quot;\&quot;}&quot;).build();</span>
        }
    }

    @GET
    @Path(&quot;/random&quot;)
    public Response getRandomPatients(@QueryParam(&quot;limit&quot;) Integer limit) {
        try {
<span class="fc bfc" id="L72" title="All 2 branches covered.">            if (limit == null) {</span>
<span class="fc" id="L73">                limit = 50;</span>
            }
<span class="fc" id="L75">            List&lt;Patient&gt; patients = em.createNamedQuery(&quot;Patient.findRandom&quot;, Patient.class)</span>
<span class="fc" id="L76">                    .setMaxResults(limit)</span>
<span class="fc" id="L77">                    .getResultList();</span>
<span class="fc" id="L78">            GenericEntity&lt;List&lt;Patient&gt;&gt; entity = new GenericEntity&lt;List&lt;Patient&gt;&gt;(patients) {</span>
            };
<span class="fc" id="L80">            return Response.ok(entity).build();</span>
<span class="nc" id="L81">        } catch (Exception e) {</span>
<span class="nc" id="L82">            return Response.status(Response.Status.INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L83">                    .entity(&quot;{\&quot;error\&quot;: \&quot;&quot; + e.getMessage() + &quot;\&quot;}&quot;).build();</span>
        }
    }

    @GET
    @Path(&quot;/search&quot;)
    public Response searchPatients(
            @QueryParam(&quot;q&quot;) String query,
            @QueryParam(&quot;offset&quot;) Integer offset,
            @QueryParam(&quot;limit&quot;) Integer limit) {
        try {
<span class="fc bfc" id="L94" title="All 4 branches covered.">            if (query == null || query.trim().isEmpty()) {</span>
<span class="fc" id="L95">                return Response.status(Response.Status.BAD_REQUEST)</span>
<span class="fc" id="L96">                        .entity(&quot;{\&quot;error\&quot;: \&quot;Suchbegriff erforderlich\&quot;}&quot;).build();</span>
            }

<span class="fc bfc" id="L99" title="All 2 branches covered.">            if (offset == null)</span>
<span class="fc" id="L100">                offset = 0;</span>
<span class="fc bfc" id="L101" title="All 2 branches covered.">            if (limit == null)</span>
<span class="fc" id="L102">                limit = 100;</span>

<span class="fc" id="L104">            String searchPattern = &quot;%&quot; + query.trim() + &quot;%&quot;;</span>

            // Hole Gesamtanzahl
<span class="fc" id="L107">            Long totalCount = em.createNamedQuery(&quot;Patient.countByNameSearch&quot;, Long.class)</span>
<span class="fc" id="L108">                    .setParameter(&quot;search&quot;, searchPattern)</span>
<span class="fc" id="L109">                    .getSingleResult();</span>

            // Hole paginierte Ergebnisse
<span class="fc" id="L112">            List&lt;Patient&gt; patients = em.createNamedQuery(&quot;Patient.searchByNameOptimized&quot;, Patient.class)</span>
<span class="fc" id="L113">                    .setParameter(&quot;search&quot;, searchPattern)</span>
<span class="fc" id="L114">                    .setFirstResult(offset)</span>
<span class="fc" id="L115">                    .setMaxResults(limit)</span>
<span class="fc" id="L116">                    .getResultList();</span>

            // Baue Response mit Metadaten
<span class="fc" id="L119">            String json = String.format(</span>
                    &quot;{\&quot;total\&quot;:%d,\&quot;offset\&quot;:%d,\&quot;limit\&quot;:%d,\&quot;hasMore\&quot;:%b,\&quot;patients\&quot;:[&quot;,
<span class="fc bfc" id="L121" title="All 2 branches covered.">                    totalCount, offset, limit, (offset + limit) &lt; totalCount);</span>

<span class="fc" id="L123">            StringBuilder patientsJson = new StringBuilder();</span>
<span class="fc bfc" id="L124" title="All 2 branches covered.">            for (int i = 0; i &lt; patients.size(); i++) {</span>
<span class="fc" id="L125">                Patient p = patients.get(i);</span>
<span class="pc bpc" id="L126" title="1 of 2 branches missed.">                if (i &gt; 0)</span>
<span class="nc" id="L127">                    patientsJson.append(&quot;,&quot;);</span>
<span class="fc" id="L128">                patientsJson.append(String.format(</span>
                        &quot;{\&quot;id\&quot;:%d,\&quot;firstName\&quot;:\&quot;%s\&quot;,\&quot;lastName\&quot;:\&quot;%s\&quot;,&quot; +
                                &quot;\&quot;dateOfBirth\&quot;:\&quot;%s\&quot;,\&quot;gender\&quot;:\&quot;%s\&quot;,&quot; +
                                &quot;\&quot;phone\&quot;:\&quot;%s\&quot;,\&quot;email\&quot;:\&quot;%s\&quot;,\&quot;address\&quot;:\&quot;%s\&quot;,&quot; +
                                &quot;\&quot;insuranceNumber\&quot;:\&quot;%s\&quot;,\&quot;bloodType\&quot;:\&quot;%s\&quot;,&quot; +
                                &quot;\&quot;allergies\&quot;:\&quot;%s\&quot;,\&quot;emergencyContactName\&quot;:\&quot;%s\&quot;,&quot; +
                                &quot;\&quot;emergencyContactPhone\&quot;:\&quot;%s\&quot;,\&quot;status\&quot;:\&quot;%s\&quot;,&quot; +
                                &quot;\&quot;epaEnabled\&quot;:%b,\&quot;epaSyncStatus\&quot;:\&quot;%s\&quot;}&quot;,
<span class="fc" id="L136">                        p.getId(),</span>
<span class="fc" id="L137">                        escapeJson(p.getFirstName()),</span>
<span class="fc" id="L138">                        escapeJson(p.getLastName()),</span>
<span class="fc" id="L139">                        p.getDateOfBirth().toString(),</span>
<span class="fc" id="L140">                        escapeJson(p.getGender()),</span>
<span class="fc" id="L141">                        escapeJson(p.getPhone()),</span>
<span class="fc" id="L142">                        escapeJson(p.getEmail()),</span>
<span class="fc" id="L143">                        escapeJson(p.getAddress()),</span>
<span class="fc" id="L144">                        escapeJson(p.getInsuranceNumber()),</span>
<span class="fc" id="L145">                        escapeJson(p.getBloodType()),</span>
<span class="fc" id="L146">                        escapeJson(p.getAllergies()),</span>
<span class="fc" id="L147">                        escapeJson(p.getEmergencyContactName()),</span>
<span class="fc" id="L148">                        escapeJson(p.getEmergencyContactPhone()),</span>
<span class="fc" id="L149">                        escapeJson(p.getStatus()),</span>
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">                        p.getEpaEnabled() != null ? p.getEpaEnabled() : true,</span>
<span class="fc" id="L151">                        escapeJson(p.getEpaSyncStatus())));</span>
            }

<span class="fc" id="L154">            json += patientsJson.toString() + &quot;]}&quot;;</span>

<span class="fc" id="L156">            return Response.ok(json).type(MediaType.APPLICATION_JSON).build();</span>
<span class="nc" id="L157">        } catch (Exception e) {</span>
<span class="nc" id="L158">            e.printStackTrace();</span>
<span class="nc" id="L159">            return Response.status(Response.Status.INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L160">                    .entity(&quot;{\&quot;error\&quot;: \&quot;&quot; + e.getMessage() + &quot;\&quot;}&quot;).build();</span>
        }
    }

    // Hilfsmethode f√ºr JSON Escaping
    private String escapeJson(String str) {
<span class="fc bfc" id="L166" title="All 2 branches covered.">        if (str == null)</span>
<span class="fc" id="L167">            return &quot;&quot;;</span>
<span class="fc" id="L168">        return str.replace(&quot;\\&quot;, &quot;\\\\&quot;)</span>
<span class="fc" id="L169">                .replace(&quot;\&quot;&quot;, &quot;\\\&quot;&quot;)</span>
<span class="fc" id="L170">                .replace(&quot;\n&quot;, &quot;\\n&quot;)</span>
<span class="fc" id="L171">                .replace(&quot;\r&quot;, &quot;\\r&quot;)</span>
<span class="fc" id="L172">                .replace(&quot;\t&quot;, &quot;\\t&quot;);</span>
    }

    @POST
    public Response createPatient(Patient patient) {
        try {
<span class="fc" id="L178">            em.persist(patient);</span>
<span class="fc" id="L179">            em.flush();</span>
<span class="fc" id="L180">            return Response.status(Response.Status.CREATED).entity(patient).build();</span>
<span class="nc" id="L181">        } catch (Exception e) {</span>
<span class="nc" id="L182">            return Response.status(Response.Status.BAD_REQUEST)</span>
<span class="nc" id="L183">                    .entity(&quot;{\&quot;error\&quot;: \&quot;&quot; + e.getMessage() + &quot;\&quot;}&quot;).build();</span>
        }
    }

    @PUT
    @Path(&quot;/{id}&quot;)
    public Response updatePatient(@PathParam(&quot;id&quot;) Long id, Patient updatedPatient) {
        try {
<span class="fc" id="L191">            Patient patient = em.find(Patient.class, id);</span>
<span class="fc bfc" id="L192" title="All 2 branches covered.">            if (patient == null) {</span>
<span class="fc" id="L193">                return Response.status(Response.Status.NOT_FOUND)</span>
<span class="fc" id="L194">                        .entity(&quot;{\&quot;error\&quot;: \&quot;Patient nicht gefunden\&quot;}&quot;).build();</span>
            }

<span class="fc" id="L197">            patient.setFirstName(updatedPatient.getFirstName());</span>
<span class="fc" id="L198">            patient.setLastName(updatedPatient.getLastName());</span>
<span class="fc" id="L199">            patient.setDateOfBirth(updatedPatient.getDateOfBirth());</span>
<span class="fc" id="L200">            patient.setGender(updatedPatient.getGender());</span>
<span class="fc" id="L201">            patient.setPhone(updatedPatient.getPhone());</span>
<span class="fc" id="L202">            patient.setEmail(updatedPatient.getEmail());</span>
<span class="fc" id="L203">            patient.setAddress(updatedPatient.getAddress());</span>
<span class="fc" id="L204">            patient.setInsuranceNumber(updatedPatient.getInsuranceNumber());</span>
<span class="fc" id="L205">            patient.setBloodType(updatedPatient.getBloodType());</span>
<span class="fc" id="L206">            patient.setAllergies(updatedPatient.getAllergies());</span>
<span class="fc" id="L207">            patient.setEmergencyContactName(updatedPatient.getEmergencyContactName());</span>
<span class="fc" id="L208">            patient.setEmergencyContactPhone(updatedPatient.getEmergencyContactPhone());</span>
<span class="fc" id="L209">            patient.setStatus(updatedPatient.getStatus());</span>
<span class="fc" id="L210">            patient.setDischargeDate(updatedPatient.getDischargeDate());</span>

<span class="fc" id="L212">            em.merge(patient);</span>
<span class="fc" id="L213">            em.flush();</span>
<span class="fc" id="L214">            return Response.ok(patient).build();</span>
<span class="nc" id="L215">        } catch (Exception e) {</span>
<span class="nc" id="L216">            return Response.status(Response.Status.BAD_REQUEST)</span>
<span class="nc" id="L217">                    .entity(&quot;{\&quot;error\&quot;: \&quot;&quot; + e.getMessage() + &quot;\&quot;}&quot;).build();</span>
        }
    }

    @DELETE
    @Path(&quot;/{id}&quot;)
    public Response deletePatient(@PathParam(&quot;id&quot;) Long id) {
        try {
<span class="fc" id="L225">            Patient patient = em.find(Patient.class, id);</span>
<span class="fc bfc" id="L226" title="All 2 branches covered.">            if (patient == null) {</span>
<span class="fc" id="L227">                return Response.status(Response.Status.NOT_FOUND)</span>
<span class="fc" id="L228">                        .entity(&quot;{\&quot;error\&quot;: \&quot;Patient nicht gefunden\&quot;}&quot;).build();</span>
            }
<span class="fc" id="L230">            em.remove(patient);</span>
<span class="fc" id="L231">            return Response.noContent().build();</span>
<span class="nc" id="L232">        } catch (Exception e) {</span>
<span class="nc" id="L233">            return Response.status(Response.Status.INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L234">                    .entity(&quot;{\&quot;error\&quot;: \&quot;&quot; + e.getMessage() + &quot;\&quot;}&quot;).build();</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>